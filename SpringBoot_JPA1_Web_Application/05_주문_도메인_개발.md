## 0. 목차
- 주문, 주문상품 엔티티 개발
- 주문 리포지토리 개발
- 주문 서비스 개발
- 주문 기능 테스트
- 주문 검색 기능 개발

## 1. 주문, 주문상품 엔티티 개발

### 1-1. 구현 기능
- 상품 주문
- 주문 내역 조회
- 주문 취소

### 1-2. 주문 엔티티 코드
- domain/Order.class
  ```java
  @Entity
  @Table(name = "orders") // ORDER 가 예약어(키워드)여서 오류가 발생하는
  @Getter @Setter         // DB가 있어서 안전하게 테이블 이름을 바꿔놓은 것 같아요
  public class Order {

      @Id @GeneratedValue
      @Column(name = "order_id")
      private Long id;

      @ManyToOne(fetch = FetchType.LAZY) // Member와 1:N 관계 Order이 M이니까 ManyToOne
      @JoinColumn(name = "member_id") // 맵핑을 무엇으로 할거냐, FK이름이 member_id가 된다.
      private Member member;

      @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
      private List<OrderItem> orderItems = new ArrayList<>();

      @OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)
      @JoinColumn(name = "delivery_id")
      private Delivery delivery;

      private LocalDateTime orderDate; // 주문시간

      @Enumerated(EnumType.STRING)
      private OrderStatus status; // 주문상태 [ORDER, CANCEL]

      //==연관관계 편의 메서드==//
      public void setMember(Member member) {
          this.member = member;
          member.getOrders().add(this);
      }

      public void addOrderItem(OrderItem orderItem) {
          orderItems.add(orderItem);
          orderItem.setOrder(this);
      }

      public void setDelivery(Delivery delivery) {
          this.delivery = delivery;
          delivery.setOrder(this);
      }

      //==생성 메서드==//
      /*
      Order만 생성하는게 아닌 연관관계인 OrderItem, Delivery 등 도 있어여한다 -> 복잡
      이렇게 복잡할때는 별도의 생성 메서드가 있으면 좋다
      */
      public static Order createOrder(Member member, Delivery delivery, OrderItem... orderItems) {
          // OrderItem은 여러개 넘길수 있으므로 OrderItem... 문법
          Order order = new Order();
          order.setMember(member);
          order.setDelivery(delivery);
          for (OrderItem orderItem : orderItems) {
              order.addOrderItem(orderItem);
          }

          order.setStatus(OrderStatus.ORDER); // 처음에는 배송상태를 ORDER로 강제
          order.setOrderDate(LocalDateTime.now());
          return order;
      }

      //==비지니스 로직==//
      //주문취소
      public void cancel() {
          if (delivery.getStauts() == DeliveryStatus.COMP) {
              throw new IllegalStateException("이미 배송완료된 상품은 취소가 불가능합니다.");
          }

          this.setStatus(OrderStatus.CANCEL);
          for (OrderItem orderItem : orderItems) {
              orderItem.cancel(); // 주문이 취소되면 orderItem에 각각 취소를 진행
          }
      }

      //==조회 로직==//
      //전체 주문 가격 조회
      public int getTotalPrice() {
          int totalPrice = 0;
          for (OrderItem orderItem : orderItems) {
              totalPrice += orderItem.getTotalPrice();
          }
          return totalPrice;
      }
  }
  ```

- 기능설명
  - 생성 메서드( createOrder() )
    - 주문 엔티티를 생성할 때 사용. 주문 회원, 배송정보, 주문상품의 정보를 받아서 실제 주문 엔티티를 생성
  - 주문 취소( cancel() )
    - 주문 취소시 사용한다. 주문 상태를 취소로 변경하고 주문상품에 주문 취소를 알림
    - 만약 이미 배송을 완료한 상품이면 주문을 취소하지 못하도록 예외를 발생
  - 전체 주문 가격 조회
    - 주문 시 사용한 전체 주문 가격을 조회. 전체 주문 가격을 알려면 각각의 주문상품 가격을 알아야 함
    - 로직을 보면 연관된 주문상품들의 가격을 조회해서 더한 값을 반환
    - 실무에서는 주로 주문에 전체 주문 가격 필드를 두고 역정규화 함

### 1-3. 주문 상품 엔티티 코드
- domain/OrderItem.java
  ```java
  @Entity
  @Getter @Setter
  public class OrderItem {

      @Id
      @GeneratedValue
      @Column(name = "order_item_id")
      private Long id;

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "item_id")
      private Item item;

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "order_id")
      private Order order;

      private int orderPrice; // 주문가격
      private int count; //주문 수량

      //==생성 메서드==//
      public static OrderItem createOrderItem(Item item, int orderPrice, int count) {
          OrderItem orderItem = new OrderItem();
          orderItem.setItem(item);
          orderItem.setOrderPrice(orderPrice);
          orderItem.setCount(count);

          item.removeStock(count);
          return orderItem;
      }

      //==비지니스 로직==//
      public void cancel() {
          getItem().addStock(count); //Item의 재고수량 원복

      }

      public int getTotalPrice() {
          return getOrderPrice() * getCount();
      }
  }
  ```

## 2. 주문 리포지토리 개발

### 2-1. 주문 리포지토리 코드
- repository/OrderRepository
  ```java
  @Repository
  @RequiredArgsConstructor
  public class OrderRepository {

      private final EntityManager em;

      public void save(Order order) {
          em.persist(order);
      }

      public Order findOne(Long id) {
          return em.find(Order.class, id);
      }
      
  //    public List<Order> findAll(OrderSearch orderSearch) {} //검색은 나중에 작성 어려우니까
  }
  ```

## 3. 주문 서비스 개발
### 3-1. 주문 서비스 코드
